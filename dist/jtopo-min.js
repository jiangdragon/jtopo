/**
 * JTOPO 0.4.8_01
 * @author 傻大
 * @Email jiangdragon@126.com | jiang_long@topsec.com.cn
 * @build 2016-03-22
 */

!function(a){var b={version:"0.1.0",zIndex_Container:1,zIndex_Link:2,zIndex_Node:3,SceneMode:{normal:"normal",drag:"drag",edit:"edit",select:"select"},MouseCursor:{}};a.JTopo=b}(window),function(a){a.Element=function(){this.initialize=function(){this.elementType="element",this.serializedProperties=["elementType"],this.propertiesStack=[],this._id=""+(new Date).getTime()},this.distroy=function(){},this.removeHandler=function(){},this.attr=function(a,b){if(null!=a&&null!=b)this[a]=b;else if(null!=a)return this[a];return this}}}(JTopo),function(a){a.Stage=function(b){this.initialize=function(a){this.canvas=a,this.graphics=a.getContext("2d"),this.childs=[],this.frames=24,this.wheelZoom=null,this.mouseDownX=0,this.mouseDownY=0,this.mouseDown=!1,this.mouseOver=!1,this.needRepaint=!0,this.serializedProperties=["frames","wheelZoom"]},this.start=function(){0==c.frames?setTimeout(arguments.callee,100):c.frames<0?(c.repaint(),setTimeout(arguments.callee,1e3/-c.frames)):(c.repaint(),setTimeout(arguments.callee,1e3/c.frames))},this.dispatchEventToScenes=function(a,b){},this.initEvent=function(b){a.util.isIE||!window.addEventListener?(b.onmouseout=f,b.onmouseover=e,b.onmousedown=g,b.onmouseup=h,b.onmousemove=i,b.onclick=j,b.ondblclick=k,b.onmousewheel=l,b.touchstart=g,b.touchmove=i,b.touchend=h):(b.addEventListener("mouseout",f),b.addEventListener("mouseover",e),b.addEventListener("mousedown",g),b.addEventListener("mouseup",h),b.addEventListener("mousemove",i),b.addEventListener("click",j),b.addEventListener("dblclick",k),a.util.isFirefox?b.addEventListener("DOMMouseScroll",l):b.addEventListener("mousewheel",l)),window.addEventListener&&(window.addEventListener("keydown",this.keyEventHander,!0),window.addEventListener("keyup",this.keyEventHander,!0))},this.getPosition=function(b){var c=a.util.getEventPosition(b),d=a.util.getOffsetPosition(this.canvas);return c.offsetLeft=c.pageX-d.left,c.offsetTop=c.pageY-d.top,c.x=c.offsetLeft,c.y=c.offsetTop,c.target=null,c},this.mouseOvertHander=function(a){document.onselectstart=function(){return!1},c.mouseOver=!0;var b=c.getPosition(a);c.dispatchEventToScenes("mouseover",b)},this.keyEventHander=function(b){c.dispatchEventToScenes(b.type,a.util.cloneEvent(b));var d=b.keyCode;37!=d&&38!=d&&39!=d&&40!=d||(b.preventDefault?b.preventDefault():(b=b||window.event,b.returnValue=!1))},this.paint=function(){if(null!=this.canvas){this.graphics.save(),this.graphics.clearRect(0,0,this.width,this.height);var a,b;for(a=0;a<this.childs.length;a++)b=this.childs[a],1==b.visible&&b.repaint(this.graphics);this.graphics.restore()}},this.repaint=function(){0!=this.frames&&(this.paint(),this.frames<0&&0==this.needRepaint&&(this.needRepaint=!1))},this.add=function(a){for(var b=0;b<this.childs.length;b++)if(this.childs[b]===a)return;a.addTo(this),this.childs.push(a)};var c=this;null!=b&&this.initialize(b),document.oncontextmenu=function(){return!1},this.start()},a.Stage.prototype={get width(){return this.canvas.width},get height(){return this.canvas.height}}}(JTopo),function(a){a.Scene=function(b){this.initialize=function(){a.Scene.prototype.initialize.apply(this,arguments),this.elementType="scene",this.childs=[],this.zIndexMap={},this.zIndexArray=[],this.backgroundColor="255,255,255",this.visible=!0,this.alpha=0,this.scaleX=1,this.scaleY=1,this.mode=a.SceneMode.normal,this.translate=!0,this.translateX=0,this.translateY=0,this.lastTranslateX=0,this.lastTranslateY=0,this.mouseDown=!1,this.mouseDownX=null,this.mouseDownY=null,this.mouseDownEvent=null,this.areaSelect=!0,this.operations=[],this.selectedElements=[],this.paintAll=!1},this.addTo=function(a){null!=a&&this.stage!==a&&(this.stage=a)},this.paint=function(a){if(1==this.visible&&null!=this.stage){if(a.save(),this.paintBackgroud(a),a.restore(),a.save(),a.scale(this.scaleX,this.scaleY),1==this.translate){var b=this.getOffsetTranslate(a);a.translate(b.translateX,b.translateY)}this.paintChilds(a),a.restore()}},this.repaint=function(a){1==this.visible&&this.paint(a)},this.paintBackgroud=function(a){var b=a.canvas.width,c=a.canvas.height;null!=this.background?a.drawImage(this.background,0,0,b,c):(a.beginPath(),a.fillStyle="rgba("+this.backgroundColor+","+this.alpha+")",a.fillRect(0,0,b,eight),a.closePath())},this.paintChilds=function(a){for(var b=0;b<this.zIndexArray.length;b++)for(var c=this.zIndexArray[b],d=this.zIndexMap[c],e=0;e<d.length;e++){var f=d[e];if(1==this.paintAll||this.isVisiable(f)){if(a.save(),1==f.transformAble){var g=f.getCenterLocation();a.translate(g.x,g.y),f.rotate&&a.rotate(f.rotate),a.scale(f.scaleX||1,f.scaleY||1)}f.paint(a),a.restore()}}},this.getOffsetTranslate=function(a){var b=this.stage.canvas.width,c=this.stage.canvas.height;null!=a&&"move"!=a&&(b=a.canvas.width,c=a.canvas.height);var d=b/this.scaleX/2,e=c/this.scaleY/2,f={translateX:this.translateX+(d-d*this.scaleX),translateY:this.translateY+(e-e*this.scaleY)};return f},this.isVisiable=function(a){return 0!=a.visible},this.add=function(a){this.childs.push(a),null==this.zIndexMap[a.zIndex]&&(this.zIndexMap[a.zIndex]=[],this.zIndexArray.push(a.zIndex),this.zIndexArray.sort(function(a,b){return a-b})),this.zIndexMap[""+a.zIndex].push(a)};this.initialize(),null!=b&&(b.add(this),this.addTo(b))},a.Scene.prototype=new a.Element;var b={};Object.defineProperties(a.Scene.prototype,{background:{get:function(){return this._background},set:function(a){if("string"==typeof a){var c=b[a];null==c&&(c=new Image,c.src=a,c.onload=function(){b[a]=c}),this._background=c}else this._background=a}}})}(JTopo),function(a){a.DisplayElement=function(){this.initialize=function(){a.DisplayElement.prototype.initialize.apply(this,arguments),this.elementType="displayElement",this.x=0,this.y=0,this.width=32,this.height=32,this.visible=!0,this.alpha=1,this.rotate=0,this.scaleX=1,this.scaleY=1,this.strokeColor="22,124,255",this.borderColor="22,124,255",this.fillColor="22,124,255",this.shadow=!1,this.shadowBlur=5,this.shadowColor="rgba(0,0,0,0.5)",this.shadowOffsetX=3,this.shadowOffsetY=6,this.transformAble=!1,this.zIndex=0},this.paint=function(a){a.beginPath(),a.fillStyle="rgba("+this.fillColor+","+this.alpha+")",a.rect(-this.width/2,-this.height/2,this.width,this.height),a.fill(),a.stroke(),a.closePath()},this.getLocation=function(){return{x:this.x,y:this.y}},this.setLocation=function(a,b){return this.x=a,this.y=b,this},this.getCenterLocation=function(){var a={x:this.x+this.width/2,y:this.y+this.height/2};return a},this.initialize(arguments),Object.defineProperties(a.DisplayElement.prototype,{cx:{get:function(){return this.x+this.width/2},set:function(a){this.x=a-this.width/2}},cy:{get:function(){return this.y+this.height/2},set:function(a){this.y=a-this.height/2}}})},a.DisplayElement.prototype=new a.Element}(JTopo),function(a){a.InteractiveElement=function(){this.initialize=function(){a.InteractiveElement.prototype.initialize.apply(this,arguments),this.elementType="interactiveElement",this.dragable=!1,this.selected=!1,this.showSelected=!0,this.selectedLocation=null,this.isMouseOver=!1},this.initialize(arguments)},a.InteractiveElement.prototype=new a.DisplayElement}(JTopo),function(a){a.EditableElement=function(){this.initialize=function(){a.InteractiveElement.prototype.initialize.apply(this,arguments),this.editAble=!1,this.selectedPoint=null},this.initialize(arguments)},a.EditableElement.prototype=new a.InteractiveElement}(JTopo),function(a){a.Node=function(d){this.initialize=function(b){this.elementType="node",this.zIndex=a.zIndex_Node,this.text=b,this.font="12px Consolas",this.fontColor="255,255,255",this.borderWidth=0,this.borderColor="255,255,255",this.borderRadius=null,this.dragable=!0,this.textPosition="Bottom_Center",this.textOffsetX=0,this.textOffsetY=0,this.transformAble=!0,this.inLinks=null,this.outLinks=null},this.paint=function(a){this.image||(a.beginPath(),a.fillStyle="rgba("+this.fillColor+","+this.alpha+")",null!=this.borderRadius&&0!=this.borderRadius||a.rect(-this.width/2,-this.height/2,this.width,this.height),a.fill(),a.closePath(),this.paintText(a))},this.paintText=function(a){var b=this.text;if(null!=b&&""!=b){a.beginPath(),a.font=this.font;var c=a.measureText(b).width,d=a.measureText("拓扑").width,e=this.getTextPostion(this.textPosition,c,d);a.fillStyle="rgba("+this.fontColor+", "+this.alpha+")",a.fillText(b,e.x,e.y),a.closePath()}},this.getTextPostion=function(a,d,e){var f=yy=0;return null==a||"Bottom_Center"==a?(f=-this.width/2+(this.width-d)/2,yy=this.height/2+e):"Top_Center"==a?(f=-this.width/2+(this.width-d)/2,yy=-this.height/2-e/2):"Top_Right"==a?(f=this.width/2,yy=-this.height/2-e/2):"Top_Left"==a&&(f=-this.width/2-b,yy=-this.height/2-c/2),null!=this.textOffsetX&&(f+=this.textOffsetX),null!=this.textOffsetY&&(yy+=this.textOffsetY),{x:f,y:yy}},a.Node.prototype.initialize.apply(this,[d]),this.initialize(d)},a.Node.prototype=new a.EditableElement}(JTopo);